Функция СписокЦБ_БУ(МассивВидовАктивов)
	
	Если Не Портфель.БУ Тогда
		// ИЗМЕНЕНИЕ: Исправлена опечатка - удалена лишняя точка с запятой (было "Новый Массив;;")
		Возврат Новый Массив;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВидыАктивов", МассивВидовАктивов);
	
	ПС = ПланыСчетов.Хозрасчетный;
	
	СчетаЦБ = Новый Массив;
	СчетаЦБ.Добавить(ПС.АкцииТело);
	СчетаЦБ.Добавить(ПС.ОблигацииТело);
	СчетаЦБ.Добавить(ПС.ПаиТело);
	СчетаЦБ.Добавить(ПС.ИпотечныеСертификатыТело);
	СчетаЦБ.Добавить(ПС.ДепозитарныеРаспискиТело);
	СчетаЦБ.Добавить(ПС.СтоимостьСтруктурнойНоты);
	
	Счет66_04_1 = ПС.ПолученныеЗаймыПоОперациямРЕПОТело;
	// ИЗМЕНЕНИЕ: Добавлена переменная СчетОбеспечения для использования в массиве СчетаДополнительные
	СчетОбеспечения = ПС.ОбеспеченияОбязательствПолученные;
	
	// ИЗМЕНЕНИЕ: Создан массив СчетаДополнительные для объединения запросов по дополнительным счетам
	// В исходном файле использовались отдельные запросы для СчетОбеспечения (Субконто2) и Счет66_04_1 (Субконто3)
	СчетаДополнительные = Новый Массив;
	СчетаДополнительные.Добавить(СчетОбеспечения);
	СчетаДополнительные.Добавить(Счет66_04_1);
	
	// ИЗМЕНЕНИЕ: Добавлен массив ВидыСубконто для использования в виртуальных таблицах
	// Позволяет привести все субконто (Субконто2 и Субконто3) к Субконто1 в виртуальных таблицах
	ВидыСубконто = Новый Массив;
	ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.ЦенныеБумаги);
	
	Запрос.УстановитьПараметр("Портфель", Портфель);
	Запрос.УстановитьПараметр("ДатаН", НачалоДня(Дата));
	Запрос.УстановитьПараметр("ДатаК", КонецДня(Дата));
	Запрос.УстановитьПараметр("СчетаЦБ", СчетаЦБ);
	// ИЗМЕНЕНИЕ: Добавлен параметр СчетаДополнительные (объединяет СчетОбеспечения и Счет66_04_1)
	Запрос.УстановитьПараметр("СчетаДополнительные", СчетаДополнительные);
	// ИЗМЕНЕНИЕ: Добавлен параметр ВидыСубконто для использования в виртуальных таблицах
	Запрос.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
	// ИЗМЕНЕНИЕ: Удален параметр Счет66_04_1 (используется только через массив СчетаДополнительные)
	
	Запрос.Текст =
		"// ИЗМЕНЕНИЕ: Первые два запроса (обороты и остатки по основным счетам ЦБ) выделены в отдельную виртуальную таблицу ВТ_ОбъектыОсновныхСчетов
		|// В исходном файле (строки 29-81) все 6 запросов объединялись в одну таблицу ТаблицаВсеЦБ через ОБЪЕДИНИТЬ ВСЕ
		|ВЫБРАТЬ
		|	ХозрасчетныйОбороты.Субконто1 КАК Субконто1
		|ПОМЕСТИТЬ ВТ_ОбъектыОсновныхСчетов
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Обороты(&ДатаН, &ДатаК, Период, Счет В (&СчетаЦБ), , Портфель = &Портфель, , ) КАК ХозрасчетныйОбороты
		|ГДЕ
		|	ХозрасчетныйОбороты.КоличествоОборот <> 0
		|
		|	// ИЗМЕНЕНИЕ: ОБЪЕДИНИТЬ ВСЕ (строка 37 исходного файла) заменено на ОБЪЕДИНИТЬ для автоматического удаления дублей
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ДатаК, Счет В (&СчетаЦБ), , Портфель = &Портфель) КАК ХозрасчетныйОстатки
		|ГДЕ
		|	ХозрасчетныйОстатки.КоличествоОстаток <> 0
		|
		|	// ИЗМЕНЕНИЕ: Добавлен индекс по Субконто1 для оптимизации соединения со справочником Активы
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|// ИЗМЕНЕНИЕ: Создан финальный SELECT (без создания промежуточной виртуальной таблицы)
		|// В исходном файле были две промежуточные таблицы:
		|// - ТаблицаВсеЦБ (строки 29-81): содержала все 6 запросов с объектами через ВЫРАЗИТЬ(...).Объект
		|// - ТаблицаЦБ (строки 84-95): группировка по Субконто1
		|// И финальный SELECT (строки 98-107): JOIN со справочником Активы с фильтром по ВидАктива
		|// ИЗМЕНЕНИЕ: Преобразует объекты из ВТ_ОбъектыОсновныхСчетов в ссылки на Активы через JOIN
		|// ИЗМЕНЕНИЕ: Фильтрация по ВидАктива перенесена в условие JOIN (в исходном файле была в WHERE финального SELECT)
		|ВЫБРАТЬ
		|	Активы.Ссылка КАК Актив
		|ИЗ
		|	ВТ_ОбъектыОсновныхСчетов КАК ВТ_ОбъектыОсновныхСчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Активы КАК Активы
		|		ПО ВТ_ОбъектыОсновныхСчетов.Субконто1 = Активы.Объект
		|			И (Активы.ВидАктива В ИЕРАРХИИ (&ВидыАктивов))
		|
		|	// ИЗМЕНЕНИЕ: Третий и пятый запросы (обороты по дополнительным счетам) объединены в один запрос
		|	// В исходном файле были два отдельных запроса:
		|	// - третий (строки 48-53): обороты по СчетОбеспечения, Субконто2, использовалось ВЫРАЗИТЬ(...Субконто2...).Объект
		|	// - пятый (строки 66-71): обороты по Счет66_04_1, Субконто3, использовалось ВЫРАЗИТЬ(...Субконто3...).Объект
		|	// Теперь используется один запрос с условием Счет В (&СчетаДополнительные)
		|	// ИЗМЕНЕНИЕ: Добавлен параметр &ВидыСубконто (5-й параметр в Обороты), все субконто приведены к Субконто1
		|	// ИЗМЕНЕНИЕ: Добавлена фильтрация по ВидАктива в WHERE через ВЫРАЗИТЬ (в исходном файле этой фильтрации не было)
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ХозрасчетныйОбороты.Субконто1
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Обороты(&ДатаН, &ДатаК, Период, Счет В (&СчетаДополнительные), &ВидыСубконто, Портфель = &Портфель, , ) КАК ХозрасчетныйОбороты
		|ГДЕ
		|	ХозрасчетныйОбороты.КоличествоОборот <> 0
		|	И ВЫРАЗИТЬ(ХозрасчетныйОбороты.Субконто1 КАК Справочник.Активы) В ИЕРАРХИИ (&ВидыАктивов)
		|
		|	// ИЗМЕНЕНИЕ: Четвертый и шестой запросы (остатки по дополнительным счетам) объединены в один запрос
		|	// В исходном файле были два отдельных запроса:
		|	// - четвертый (строки 57-62): остатки по СчетОбеспечения, Субконто2, использовалось ВЫРАЗИТЬ(...Субконто2...).Объект
		|	// - шестой (строки 75-80): остатки по Счет66_04_1, Субконто3, использовалось ВЫРАЗИТЬ(...Субконто3...).Объект
		|	// Теперь используется один запрос с условием Счет В (&СчетаДополнительные)
		|	// ИЗМЕНЕНИЕ: Добавлен параметр &ВидыСубконто (3-й параметр в Остатки), все субконто приведены к Субконто1
		|	// ИЗМЕНЕНИЕ: Добавлена фильтрация по ВидАктива в WHERE через ВЫРАЗИТЬ (в исходном файле этой фильтрации не было)
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ДатаК, Счет В (&СчетаДополнительные), &ВидыСубконто, Портфель = &Портфель) КАК ХозрасчетныйОстатки
		|ГДЕ
		|	ХозрасчетныйОстатки.КоличествоОстаток <> 0
		|	И ВЫРАЗИТЬ(ХозрасчетныйОстатки.Субконто1 КАК Справочник.Активы) В ИЕРАРХИИ (&ВидыАктивов)";
	
	ОбщегоНазначенияДУ.ДобавитьВЛогОтладки(Запрос, "Документ.УстановкаКотировокЦБ.МодульОбъекта:СписокЦБ_БУ");
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Актив");
	
КонецФункции