Функция СписокЦБ_БУ(МассивВидовАктивов)
	
	// ИЗМЕНЕНИЕ: Удалена лишняя точка с запятой в "Новый Массив;;"
	Если Не Портфель.БУ Тогда
		Возврат Новый Массив;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ВидыАктивов", МассивВидовАктивов);
	
	ПС = ПланыСчетов.Хозрасчетный;
	
	СчетаЦБ = Новый Массив;
	СчетаЦБ.Добавить(ПС.АкцииТело);
	СчетаЦБ.Добавить(ПС.ОблигацииТело);
	СчетаЦБ.Добавить(ПС.ПаиТело);
	СчетаЦБ.Добавить(ПС.ИпотечныеСертификатыТело);
	СчетаЦБ.Добавить(ПС.ДепозитарныеРаспискиТело);
	СчетаЦБ.Добавить(ПС.СтоимостьСтруктурнойНоты);
	
	Счет66_04_1 = ПС.ПолученныеЗаймыПоОперациямРЕПОТело;
	// ИЗМЕНЕНИЕ: Добавлена переменная СчетОбеспечения для использования в массиве
	СчетОбеспечения = ПС.ОбеспеченияОбязательствПолученные;
	
	// ИЗМЕНЕНИЕ: Создан массив СчетаДополнительные для объединения запросов по дополнительным счетам
	// (ранее были отдельные запросы для СчетОбеспечения и Счет66_04_1)
	СчетаДополнительные = Новый Массив;
	СчетаДополнительные.Добавить(СчетОбеспечения);
	СчетаДополнительные.Добавить(Счет66_04_1);
	
	// ИЗМЕНЕНИЕ: Добавлен массив ВидыСубконто для приведения всех субконто к Субконто1 в виртуальных таблицах
	ВидыСубконто = Новый Массив;
	ВидыСубконто.Добавить(ПланыВидовХарактеристик.ВидыСубконто.ЦенныеБумаги);
	
	Запрос.УстановитьПараметр("Портфель", Портфель);
	Запрос.УстановитьПараметр("ДатаН", НачалоДня(Дата));
	Запрос.УстановитьПараметр("ДатаК", КонецДня(Дата));
	Запрос.УстановитьПараметр("СчетаЦБ", СчетаЦБ);
	// ИЗМЕНЕНИЕ: Добавлен параметр СчетаДополнительные (объединяет СчетОбеспечения и Счет66_04_1)
	Запрос.УстановитьПараметр("СчетаДополнительные", СчетаДополнительные);
	// ИЗМЕНЕНИЕ: Добавлен параметр ВидыСубконто для использования в виртуальных таблицах
	Запрос.УстановитьПараметр("ВидыСубконто", ВидыСубконто);
	// ИЗМЕНЕНИЕ: Удалены параметры Счет66_04_1 и СчетОбеспечения (используются только через массив СчетаДополнительные)
	
	Запрос.Текст =
		"// ИЗМЕНЕНИЕ 1: Первые два запроса (обороты и остатки по основным счетам ЦБ) выделены в отдельную виртуальную таблицу
		|// ИЗМЕНЕНИЕ 2: Переименована таблица ТаблицаВсеЦБ -> ВТ_ОбъектыОсновныхСчетов (с префиксом ВТ_ для ясности)
		|ВЫБРАТЬ
		|	ХозрасчетныйОбороты.Субконто1 КАК Субконто1
		|ПОМЕСТИТЬ ВТ_ОбъектыОсновныхСчетов
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Обороты(&ДатаН, &ДатаК, Период, Счет В (&СчетаЦБ), , Портфель = &Портфель, , ) КАК ХозрасчетныйОбороты
		|ГДЕ
		|	ХозрасчетныйОбороты.КоличествоОборот <> 0
		|
		|	// ИЗМЕНЕНИЕ 3: ОБЪЕДИНИТЬ ВСЕ заменено на ОБЪЕДИНИТЬ для автоматического удаления дублей
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ДатаК, Счет В (&СчетаЦБ), , Портфель = &Портфель) КАК ХозрасчетныйОстатки
		|ГДЕ
		|	ХозрасчетныйОстатки.КоличествоОстаток <> 0
		|
		|	// ИЗМЕНЕНИЕ 4: Добавлен индекс по Субконто1 для оптимизации соединения со справочником Активы
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|// ИЗМЕНЕНИЕ 5: Создана вторая виртуальная таблица ВТ_Активы, которая:
		|// - Преобразует объекты из ВТ_ОбъектыОсновныхСчетов в ссылки на Активы
		|// - Объединяет с данными из дополнительных счетов (обороты и остатки)
		|// ИЗМЕНЕНИЕ 6: Переименована ТаблицаВсеЦБ -> ВТ_Активы (с префиксом ВТ_)
		|ВЫБРАТЬ
		|	Активы.Ссылка КАК Субконто1
		|ПОМЕСТИТЬ ВТ_Активы
		|ИЗ
		|	ВТ_ОбъектыОсновныхСчетов КАК ВТ_ОбъектыОсновныхСчетов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Активы КАК Активы
		|		ПО ВТ_ОбъектыОсновныхСчетов.Субконто1 = Активы.Объект
		|
		|	// ИЗМЕНЕНИЕ 7: Третий и пятый запросы (обороты по дополнительным счетам) объединены в один
		|	// Используется Счет В (&СчетаДополнительные) вместо отдельных условий для каждого счета
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ХозрасчетныйОбороты.Субконто1 КАК Субконто1
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Обороты(&ДатаН, &ДатаК, Период, Счет В (&СчетаДополнительные), &ВидыСубконто, Портфель = &Портфель, , ) КАК ХозрасчетныйОбороты
		|ГДЕ
		|	ХозрасчетныйОбороты.КоличествоОборот <> 0
		|
		|	// ИЗМЕНЕНИЕ 8: Четвертый и шестой запросы (остатки по дополнительным счетам) объединены в один
		|ОБЪЕДИНИТЬ
		|
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1 КАК Субконто1
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ДатаК, Счет В (&СчетаДополнительные), &ВидыСубконто, Портфель = &Портфель) КАК ХозрасчетныйОстатки
		|ГДЕ
		|	ХозрасчетныйОстатки.КоличествоОстаток <> 0
		|
		|	// ИЗМЕНЕНИЕ 9: Добавлен параметр &ВидыСубконто для приведения Субконто2 и Субконто3 к Субконто1
		|	// Теперь все субконто доступны через Субконто1 без использования ВЫРАЗИТЬ и .Объект
		|	// ИЗМЕНЕНИЕ 10: Добавлен индекс по Субконто1 для оптимизации финального запроса
		|ИНДЕКСИРОВАТЬ ПО
		|	Субконто1
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|// ИЗМЕНЕНИЕ 11: Упрощен финальный запрос:
		|// - Удалена промежуточная таблица ТаблицаЦБ с группировкой (ОБЪЕДИНИТЬ уже удаляет дубли)
		|// - Убрано соединение со справочником Активы (в ВТ_Активы уже хранятся ссылки на Активы)
		|// - Фильтрация по ВидАктива выполняется напрямую через ссылку (ВТ_Активы.Субконто1.ВидАктива)
		|// - Возвращается только поле Актив без Объект и ВидАктива (они не нужны)
		|ВЫБРАТЬ
		|	ВТ_Активы.Субконто1 КАК Актив
		|ИЗ
		|	ВТ_Активы КАК ВТ_Активы
		|ГДЕ
		|	ВТ_Активы.Субконто1.ВидАктива В ИЕРАРХИИ(&ВидыАктивов)";
	
	ОбщегоНазначенияДУ.ДобавитьВЛогОтладки(Запрос, "Документ.УстановкаКотировокЦБ.МодульОбъекта:СписокЦБ_БУ");
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Актив");
	
КонецФункции