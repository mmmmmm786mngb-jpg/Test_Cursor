Функция КотировкиПоБалансовойСтоимостиБУ(Знач ПараметрыРасчета)
    
    Запрос = Новый Запрос;
    Запрос.Текст =
        "// 1. Получаем плоские счета (без иерархии) по фильтрам
        |ВЫБРАТЬ РАЗЛИЧНЫЕ
        |    Счет.Ссылка КАК Счет
        |ПОМЕСТИТЬ ВТ_СчетаАктивов
        |ИЗ
        |    ПланСчетов.Хозрасчетный КАК Счет
        |ГДЕ
        |    Счет В ИЕРАРХИИ (&СчетаАктивов)
        |    И НЕ Счет В (&СчетаНКД)
        |
        |ИНДЕКСИРОВАТЬ ПО
        |    Счет
        |;
        |
        |// 2. Получаем только Объекты активов (минимальный набор)
        |ВЫБРАТЬ
        |    Активы.Объект КАК Объект
        |ПОМЕСТИТЬ ВТ_АктивыОбъекты
        |ИЗ
        |    Справочник.Активы КАК Активы
        |ГДЕ
        |    Активы.Ссылка В (&МассивАктивов)
        |
        |ИНДЕКСИРОВАТЬ ПО
        |    Объект
        |;
        |
        |// 3. Получаем остатки без группировки (переносим группировку в финальный запрос)
        |ВЫБРАТЬ
        |    Остатки.Субконто1 КАК Объект,
        |    Остатки.Валюта КАК Валюта,
        |    Остатки.ВалютнаяСуммаОстатокДт КАК СуммаОстаток,
        |    Остатки.КоличествоОстаток КАК КоличествоОстаток
        |ПОМЕСТИТЬ ВТ_Остатки
        |ИЗ
        |    РегистрБухгалтерии.Хозрасчетный.Остатки(
        |        &ДатаК,
        |        Счет В (ВЫБРАТЬ Счет.Счет КАК Счет ИЗ ВТ_СчетаАктивов КАК Счет),
        |        Портфель = &Портфель,
        |        Субконто1 В (ВЫБРАТЬ Объекты.Объект КАК Объект ИЗ ВТ_АктивыОбъекты КАК Объекты)
        |    ) КАК Остатки
        |
        |ИНДЕКСИРОВАТЬ ПО
        |    Объект,
        |    Валюта
        |;
        |
        |// 4. Финальный запрос: соединяем, обогащаем данными и группируем
        |ВЫБРАТЬ
        |    Активы.Ссылка КАК Актив,
        |    ВТ_АктивыОбъекты.Объект КАК Объект,
        |    ВЫБОР
        |        КОГДА Активы.Объект.ВалютаНоминальнойСтоимости ЕСТЬ NULL
        |        ТОГДА ЗНАЧЕНИЕ(Справочник.Валюты.RUB)
        |        ИНАЧЕ Активы.Объект.ВалютаНоминальнойСтоимости
        |    КОНЕЦ КАК ВалютаНоминальнойСтоимости,
        |    Активы.ВидАктива КАК ВидАктива,
        |    СУММА(ВТ_Остатки.СуммаОстаток) КАК СуммаОстаток,
        |    СУММА(ВТ_Остатки.КоличествоОстаток) КАК КоличествоОстаток
        |ИЗ
        |    Справочник.Активы КАК Активы
        |    ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_АктивыОбъекты КАК ВТ_АктивыОбъекты
        |        ПО Активы.Объект = ВТ_АктивыОбъекты.Объект
        |    ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТ_Остатки КАК ВТ_Остатки
        |        ПО ВТ_АктивыОбъекты.Объект = ВТ_Остатки.Объект
        |           И ВТ_Остатки.Валюта = Активы.Объект.ВалютаНоминальнойСтоимости
        |
        |СГРУППИРОВАТЬ ПО
        |    Активы.Ссылка,
        |    ВТ_АктивыОбъекты.Объект,
        |    ВЫБОР
        |        КОГДА Активы.Объект.ВалютаНоминальнойСтоимости ЕСТЬ NULL
        |        ТОГДА ЗНАЧЕНИЕ(Справочник.Валюты.RUB)
        |        ИНАЧЕ Активы.Объект.ВалютаНоминальнойСтоимости
        |    КОНЕЦ,
        |    Активы.ВидАктива";
    

    // Устанавливаем параметры
    Запрос.УстановитьПараметр("Портфель", ПараметрыРасчета.Портфель);
    Запрос.УстановитьПараметр("ДатаК", ПараметрыРасчета.ДатаОпределения);
    Запрос.УстановитьПараметр("МассивАктивов", ПараметрыРасчета.МассивЦББезКотировок);
    Запрос.УстановитьПараметр("СчетаАктивов", БухгалтерскийУчетПовтИсп.СчетаУчетаНеденежныхАктивов());
    Запрос.УстановитьПараметр("СчетаНКД", БухгалтерскийУчетПовтИсп.СписокСчетовУчетаКупонногоДохода());



    Результат = Запрос.Выполнить();
    ОбщегоНазначенияДУ.ДобавитьВЛогОтладки(Запрос, "Перечисление.МетодыРасчетаКотировок.МодульМенеджера:КотировкиПоБалансовойСтоимостиБУ");
    Выборка = Результат.Выбрать();
    Возврат Выборка;


КонецФункции
