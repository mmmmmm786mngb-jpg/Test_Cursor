// Описание: Оптимизированная функция для получения остатков по активам
//           с данными о валюте номинальной стоимости и виде актива
//           Изменение: запрос объединен в один без использования временной таблицы
//
// Параметры:
//   МассивАктивов - Массив - массив ссылок на элементы справочника Активы
//   ДатаК - Дата - дата получения остатков
//   СчетаАктивов - Массив - массив счетов для фильтрации активов
//   СчетаНКД - Массив - массив счетов НКД для исключения
//   Портфель - СправочникСсылка.Портфели - портфель для фильтрации
//
// Возвращаемое значение:
//   ТаблицаЗначений - таблица с результатами запроса:
//     - Объект - СправочникСсылка - ссылка на объект актива
//     - СуммаОстаток - Число - сумма остатка в валюте
//     - КоличествоОстаток - Число - количество остатка
//     - Актив - СправочникСсылка - ссылка на элемент справочника Активы
//     - ВалютаНоминальнойСтоимости - СправочникСсылка - валюта номинальной стоимости
//     - ВидАктива - ПеречислениеСсылка - вид актива
//
// Пример:
//   Результат = МетодыРасчетаКотировок(МассивАктивов, ТекущаяДата(), СчетаАктивов, СчетаНКД, Портфель);
//
Функция МетодыРасчетаКотировок(МассивАктивов, ДатаК, СчетаАктивов, СчетаНКД, Портфель)
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("МассивАктивов", МассивАктивов);
	Запрос.УстановитьПараметр("ДатаК", ДатаК);
	Запрос.УстановитьПараметр("СчетаАктивов", СчетаАктивов);
	Запрос.УстановитьПараметр("СчетаНКД", СчетаНКД);
	Запрос.УстановитьПараметр("Портфель", Портфель);
	
	// ИЗМЕНЕНИЕ: Запрос объединен в один без использования временной таблицы ВТ_Активы
	// В исходном запросе создавалась временная таблица ВТ_Активы (строки 1-16)
	// и затем использовалась во втором запросе (строки 19-41)
	// Теперь используется прямое ВНУТРЕННЕЕ СОЕДИНЕНИЕ со Справочник.Активы
	// Это повышает производительность за счет исключения создания временной таблицы
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1 КАК Объект,
		|	СУММА(ХозрасчетныйОстатки.ВалютнаяСуммаОстатокДт) КАК СуммаОстаток,
		|	СУММА(ХозрасчетныйОстатки.КоличествоОстаток) КАК КоличествоОстаток,
		|	Активы.Ссылка КАК Актив,
		|	ЕСТЬNULL(Активы.Объект.ВалютаНоминальнойСтоимости, ЗНАЧЕНИЕ(Справочник.Валюты.RUB)) КАК ВалютаНоминальнойСтоимости,
		|	Активы.ВидАктива КАК ВидАктива
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|			&ДатаК,
		|			Счет В ИЕРАРХИИ (&СчетаАктивов)
		|				И НЕ Счет В (&СчетаНКД),
		|			,
		|			Портфель = &Портфель) КАК ХозрасчетныйОстатки
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Активы КАК Активы
		|	ПО ХозрасчетныйОстатки.Субконто1 = Активы.Объект
		|		И ХозрасчетныйОстатки.Валюта = ЕСТЬNULL(Активы.Объект.ВалютаНоминальнойСтоимости, ЗНАЧЕНИЕ(Справочник.Валюты.RUB))
		|ГДЕ
		|	Активы.Ссылка В (&МассивАктивов)
		|
		|СГРУППИРОВАТЬ ПО
		|	ХозрасчетныйОстатки.Субконто1,
		|	Активы.Ссылка,
		|	ЕСТЬNULL(Активы.Объект.ВалютаНоминальнойСтоимости, ЗНАЧЕНИЕ(Справочник.Валюты.RUB)),
		|	Активы.ВидАктива";
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции
