Здравствуйте!

Спасибо за внимание к нашим замерам. Важный момент: 44 секунды на скриншоте - это не все портфели вместе, а всего лишь один портфель.

А у нас портфелей несколько тысяч. И операция "Определение сделок с отклонением цен" идет по всем портфелям (параллельно, но не более 10 портфелей одновременно). То есть это несколько секунд × сколько там портфелей = получаются часы.

Вот как было до индексации: в основном по 2-8 секунд на один портфель, а в пиковые дни бывало и до 44 секунд.

А вот после того как мы поставили индексы SQL - эта же операция выполняется стабильно за 0.1-0.16 секунды на портфель.

По операции "Определение сделок с отклонением цен" по всем портфелям:
- Без индексов SQL: 3+ часа (прервали, чтобы не грузить сервер БД)
- С индексами SQL: 20-30 минут, все стабильно
- Ускорение в 6-9 раз

Что конкретно мы сделали. Мы просто добавили индексы в SQL напрямую. В типовой платформе 1С их нет, поэтому мы сами их создали:

CREATE NONCLUSTERED INDEX VTB_DEALSBYMANDATE 
ON dbo._Document159 (_Date_Time, _Fld2880RRef, _Posted) 
INCLUDE (_Fld2881_TYPE, _Fld2881_RTRef, _Fld2881_RRRef, _Fld2890RRef, _Fld2876RRef, _Fld2882, _Fld2896, _Fld2898, _Fld2884, _Fld2883) 
WITH (ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = OFF);

где _Document159 - это документ Сделка, а _Fld2880RRef - это реквизит Портфель.

Плюс еще несколько индексов:
- VTB_AccRgED323_2 на РегистрБухгалтерии.Хозрасчетный (субконто ЗначенияСубконто)
- VTB_PAYED на Документ.ОперацияПоСчетуБрокера
- VTB_REGOPER_PLAN на Документ.ПланРегламентныхОперацийДУ

В итоге что получается. Типовая платформа 1С без наших индексов при наших объемах работает 3+ часа и перегружает сервер. Это реально проблема для закрытия периода.

А с нашими индексами - полтора часа стабильно, сервер нормально работает.

Готов ответить на дополнительные вопросы по замерам.

С уважением,  
[Ваше имя]

