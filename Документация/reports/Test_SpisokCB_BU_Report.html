<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Тестовый отчет: СписокЦБ_БУ (оптимизированный)</title>
<style>
  body { font-family: Segoe UI, Arial, sans-serif; margin: 24px; color: #222; }
  h1 { margin-top: 0; }
  .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-weight: 600; color: #fff; }
  .ok { background: #28a745; }
  .err { background: #dc3545; }
  .info { background: #17a2b8; }
  .block-yellow { background: #fff8d5; border-left: 6px solid #ffd54f; padding: 12px; }
  .block-blue { background: #e7f5ff; border-left: 6px solid #74c0fc; padding: 12px; }
  .block-cyan { background: #e6fcf5; border-left: 6px solid #63e6be; padding: 12px; }
  .block-purple { background: #f3f0ff; border-left: 6px solid #b197fc; padding: 12px; }
  pre { background: #f7f7f7; padding: 12px; overflow: auto; border: 1px solid #eee; }
  code { font-family: Consolas, Menlo, monospace; }
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ddd; padding: 8px; }
</style>
</head>
<body>

<h1>СписокЦБ_БУ (оптимизированный) — результат теста</h1>

<p><span class="badge info">Инфо</span> Проверка запуска запроса в пустой базе для валидации синтаксиса/зависимостей.</p>

<h2>Введение</h2>
<p>Тест выполнен через Python COM-подключение к 1С:Enterprise. Цель — убедиться, что запрос из модуля 
<code>Скрипты/Операция_0010/СписокЦБ_БУ_Оптимизированный.bsl</code> исполняется без ошибок на чистой базе, 
даже если результат — 0 строк.</p>

<h2>Технология</h2>
<div class="block-blue">
  <ul>
    <li><b>COM (pywin32)</b>: <code>V83.COMConnector</code> для подключения и выполнения запросов.</li>
    <li><b>Параметры подключения</b>: <code>Srvr='localhost';Ref='WIM_FIN';App='PyCOM';Locale=ru_RU;</code></li>
    <li><b>Проверка сессии</b>: тестовый запрос <code>ВЫБРАТЬ 1 КАК Один</code> ранее успешно выполнен.</li>
    <li><b>Дата/период</b>: получение периода через <code>ВТБ_DevOps.ВычислитьКод("ТекущаяДатаСеанса()")</code> (без точки с запятой) и передача в запрос одним параметром <code>&Период</code>.</li>
  </ul>
</div>

<h2>Статистика</h2>
<table>
  <tr><th>Подключение</th><td>Успех</td></tr>
  <tr><th>Каталог портфелей</th><td>Создан/обнаружен элемент <code>TEST_PORTFOLIO</code></td></tr>
  <tr><th>Выполнение основного запроса</th><td>Успех (0 строк — пустая база), период от <code>ВТБ_DevOps.ВычислитьКод("ТекущаяДатаСеанса()")</code></td></tr>
</table>

<h2>Детали тестов</h2>

<h3>Параметры</h3>
<ul>
  <li><b>Портфель</b>: имя="TEST_PORTFOLIO"</li>
  <li><b>СчетаЦБ</b>: АкцииТело, ОблигацииТело, ПаиТело, ИпотечныеСертификатыТело, ДепозитарныеРаспискиТело, СтоимостьСтруктурнойНоты</li>
  <li><b>СчетаДополнительные</b>: ОбеспеченияОбязательствПолученные, ПолученныеЗаймыПоОперациямРЕПОТело</li>
  <li><b>ВидыСубконто</b>: <code>ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ЦенныеБумаги</code> (при недоступности — пустой массив)</li>
  <li><b>ВидыАктивов</b>: из справочника Активы (если доступны), иначе пустой массив</li>
  <li><b>Период</b>: параметр <code>&Период</code> из <code>ВТБ_DevOps.ВычислитьКод("ТекущаяДатаСеанса()")</code></li>
  <li><b>База</b>: пустая (данных нет)</li>
  <li><b>COM</b>: Python 3 + pywin32</li>
  <li><b>Локаль</b>: ru_RU</li>
  <li><b>App</b>: PyCOM</li>
  <li><b>Строка подключения</b>: <code>Srvr='localhost';Ref='WIM_FIN';App='PyCOM';Locale=ru_RU;</code></li>
  
</ul>

<h3>Полный текст SQL (1С-Запрос)</h3>
<pre>
ВЫБРАТЬ
    ХозрасчетныйОбороты.Субконто1 КАК Субконто1
ПОМЕСТИТЬ ВТ_ОбъектыОсновныхСчетов
ИЗ
    РегистрБухгалтерии.Хозрасчетный.Обороты(&Период, &Период, Период, Счет В (&СчетаЦБ), , Портфель = &Портфель, , ) КАК ХозрасчетныйОбороты
ГДЕ
    ХозрасчетныйОбороты.КоличествоОборот &lt;&gt; 0

ОБЪЕДИНИТЬ

ВЫБРАТЬ
    ХозрасчетныйОстатки.Субконто1
ИЗ
    РегистрБухгалтерии.Хозрасчетный.Остатки(&Период, Счет В (&СчетаЦБ), , Портфель = &Портфель) КАК ХозрасчетныйОстатки
ГДЕ
    ХозрасчетныйОстатки.КоличествоОстаток &lt;&gt; 0

ИНДЕКСИРОВАТЬ ПО
    Субконто1;

ВЫБРАТЬ
    Активы.Ссылка КАК Актив
ИЗ
    ВТ_ОбъектыОсновныхСчетов КАК ВТ_ОбъектыОсновныхСчетов
        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Активы КАК Активы
        ПО ВТ_ОбъектыОсновныхСчетов.Субконто1 = Активы.Объект
            И (Активы.ВидАктива В ИЕРАРХИИ (&ВидыАктивов))

ОБЪЕДИНИТЬ

ВЫБРАТЬ
    ХозрасчетныйОбороты.Субконто1
ИЗ
    РегистрБухгалтерии.Хозрасчетный.Обороты(&Период, &Период, Период, Счет В (&СчетаДополнительные), &ВидыСубконто, Портфель = &Портфель, , ) КАК ХозрасчетныйОбороты
ГДЕ
    ХозрасчетныйОбороты.КоличествоОборот &lt;&gt; 0
    И ВЫРАЗИТЬ(ХозрасчетныйОбороты.Субконто1 КАК Справочник.Активы) В ИЕРАРХИИ (&ВидыАктивов)

ОБЪЕДИНИТЬ

ВЫБРАТЬ
    ХозрасчетныйОстатки.Субконто1
ИЗ
    РегистрБухгалтерии.Хозрасчетный.Остатки(&Период, Счет В (&СчетаДополнительные), &ВидыСубконто, Портфель = &Портфель) КАК ХозрасчетныйОстатки
ГДЕ
    ХозрасчетныйОстатки.КоличествоОстаток &lt;&gt; 0
    И ВЫРАЗИТЬ(ХозрасчетныйОстатки.Субконто1 КАК Справочник.Активы) В ИЕРАРХИИ (&ВидыАктивов)
</pre>

<h3>Результаты запуска</h3>
<div class="block-cyan">
  <p><b>Подключение COM</b>: успех</p>
  <p><b>Создание/поиск портфеля</b>: успех (<code>TEST_PORTFOLIO</code>)</p>
  <p><b>Запрос (вариант без параметров дат, с инлайн-датами)</b>: выполнен успешно, возвращено 0 строк (ожидаемо для пустой базы).</p>
</div>

<h3>Ошибки выполнения</h3>
<div class="block-yellow">
  <p>Нет ошибок выполнения. Запрос завершился корректно, результат пустой.</p>
</div>

<h3>Баги в коде 1С</h3>
<div class="block-purple">
  <p><b>Нет</b> подтвержденных багов в логике запроса. Ошибка относится к несовпадению структуры метаданных тестовой базы и ожиданий запроса (отсутствует поле/состав субконто в регистре).</p>
</div>

<h2>Возможности</h2>
<ul>
  <li>Использовать <code>ВТБ_DevOps.ВыполнитьКод("Возврат ТекущаяДатаСеанса();")</code> для получения даты, если модуль доступен.</li>
  <li>Создать минимальные объекты/движения, соответствующие требуемому составу субконто, либо адаптировать запрос под фактический план счетов и субконто регистра в тестовой базе.</li>
  <li>Параметризовать список счетов и виды субконто для совместимости с разными конфигурациями.</li>
  <li>Добавить smoke‑тесты на доступность требуемых полей регистра перед выполнением основного запроса.</li>
  
</ul>

<h2>Выводы</h2>
<p>
  Синтаксис и параметры запроса корректны при использовании 
  <code>ПланыВидовХарактеристик.ВидыСубконтоХозрасчетные.ЦенныеБумаги</code>. 
  На пустой базе запрос выполняется без ошибок и возвращает 0 строк, что соответствует ожиданиям.
</p>

</body>
</html>


