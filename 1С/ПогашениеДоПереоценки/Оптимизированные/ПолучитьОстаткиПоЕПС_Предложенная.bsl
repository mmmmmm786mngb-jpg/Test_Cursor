// Описание: Получает список активов по остаткам регистра ЕПС.
//           Версия с динамическим формированием условия WHERE для упрощения
//           текста запроса и избегания конструкции ВЫБОР/CASE.
//
// Параметры:
//   СписокАктивовПоОстаткам - Массив - массив для заполнения найденными активами (передается по ссылке).
//
Процедура ПолучитьОстаткиПоЕПС_Предложенная(СписокАктивовПоОстаткам)
	
	// Ранний выход, если учет по ЕПС не ведется
	Если НЕ ЕПС Тогда
		Возврат;
	КонецЕсли;
	
	// Определяем, нужно ли применять фильтр по суммовым остаткам.
	// Фильтр не нужен для линейных и аналогичных методов.
	МетодНачисления = МетодНачисленияАмортизацииПремииДисконта();
	ПрименятьФильтрПоОстаткам = НЕ (МетодНачисления = Перечисления.МетодыНачисленияАмортизацииПремииДисконта.Линейный
			ИЛИ МетодНачисления = Перечисления.МетодыНачисленияАмортизацииПремииДисконта.ПоЭСП
			ИЛИ МетодНачисления = Перечисления.МетодыНачисленияАмортизацииПремииДисконта.ЛинейноИнтервальный);
	
	// Собираем базовый текст запроса
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ЕПСОстатки.Субконто1 КАК Актив
		|ИЗ
		|	РегистрБухгалтерии.ЕПС.Остатки(
		|		&Период,
		|		Счет В (&МассивСчетовОблигаций),
		|		&МассивСубконтоЕПС,
		|		Портфель = &Портфель) КАК ЕПСОстатки";
	
	// Динамически добавляем секцию WHERE, если фильтрация необходима
	Если ПрименятьФильтрПоОстаткам Тогда
		
		УсловиеПоБУ = "ЕПСОстатки.СуммаОстатокДт > 0";
		
		// Условие по НУ добавляется, только если ведется налоговый учет
		Если НУ_ЕПС Тогда
			УсловиеПоНУ = "ЕПСОстатки.СуммаНУОстатокДт > 0";
			ТекстЗапроса = ТекстЗапроса + "
				|ГДЕ
				|	(" + УсловиеПоБУ + " ИЛИ " + УсловиеПоНУ + ")";
		Иначе
			ТекстЗапроса = ТекстЗапроса + "
				|ГДЕ
				|	" + УсловиеПоБУ;
		КонецЕсли;
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	// Установка параметров запроса
	МассивСубконтоЕПС = Новый Массив;
	МассивСубконтоЕПС.Добавить(ПланыВидовХарактеристик.ВидыСубконтоЕПС.ФинансовыеИнструменты);
	
	МассивСчетовОблигаций = УчетЕПСПовтИсп.СчетаУчетаОблигаций();
	
	Запрос.УстановитьПараметр("Портфель", Портфель);
	Запрос.УстановитьПараметр("Период", НачалоДня(Дата));
	Запрос.УстановитьПараметр("МассивСчетовОблигаций", МассивСчетовОблигаций);
	Запрос.УстановитьПараметр("МассивСубконтоЕПС", МассивСубконтоЕПС);
	
	// Выполнение запроса и заполнение списка
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		СписокАктивовПоОстаткам.Добавить(Выборка.Актив);
	КонецЦикла;
	
КонецПроцедуры
