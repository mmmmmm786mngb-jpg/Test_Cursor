// Описание: Возвращает остатки на счетах премии, амортизации и дисконта для указанных активов и партий.
//           Оптимизированная версия: использует один запрос с условными суммами вместо трех объединенных подзапросов.
//
// Возвращаемое значение:
//   ТаблицаЗначений - Таблица с колонками: Актив, Партия, Остаток, ОстатокНУ, ОстатокКомиссий, ОстатокЦБ, КоличествоЦБ
//
Функция d1tRe_ОстатокНаСчетахПремииАмортизацииДисконта()
	
	Запрос = Новый Запрос;
	
	// Формируем массивы для групп перечислений
	МассивПремияДисконт = Новый Массив;
	МассивПремияДисконт.Добавить(Перечисление.ЧастиЦенныхБумаг.Премия);
	МассивПремияДисконт.Добавить(Перечисление.ЧастиЦенныхБумаг.АмортизацияДисконта);
	
	МассивКомиссий = Новый Массив;
	МассивКомиссий.Добавить(Перечисление.ЧастиЦенныхБумаг.КомиссияБрокера);
	МассивКомиссий.Добавить(Перечисление.ЧастиЦенныхБумаг.КомиссияБиржи);
	МассивКомиссий.Добавить(Перечисление.ЧастиЦенныхБумаг.ИнаяКомиссия);
	
	ЧастьЦеннаяБумага = Перечисление.ЧастиЦенныхБумаг.ЦеннаяБумага;
	
	// Формируем общий массив для отбора
	ВсеЧастиЦБ = Новый Массив;
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ВсеЧастиЦБ, МассивПремияДисконт);
	ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ВсеЧастиЦБ, МассивКомиссий);
	ВсеЧастиЦБ.Добавить(ЧастьЦеннаяБумага);
	
	// Формируем массив видов субконто
	ВидыСубконтоЕПС = Новый Массив;
	ВидыСубконтоЕПС.Добавить(ПланыВидовХарактеристик.ВидыСубконтоЕПС.ФинансовыеИнструменты);
	ВидыСубконтоЕПС.Добавить(ПланыВидовХарактеристик.ВидыСубконтоЕПС.ЧастиЦенныхБумаг);
	ВидыСубконтоЕПС.Добавить(ПланыВидовХарактеристик.ВидыСубконтоЕПС.Партии);
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ЕПСОстатки.Субконто1 КАК Актив,
		|	ЕПСОстатки.Субконто3 КАК Партия,
		|	СУММА(ВЫБОР
		|			КОГДА ЕПСОстатки.Субконто2 В (&МассивПремияДисконт)
		|				ТОГДА ЕПСОстатки.ВалютнаяСуммаОстаток
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК Остаток,
		|	СУММА(ВЫБОР
		|			КОГДА ЕПСОстатки.Субконто2 В (&МассивПремияДисконт)
		|				ТОГДА ЕПСОстатки.СуммаНУОстаток
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК ОстатокНУ,
		|	СУММА(ВЫБОР
		|			КОГДА ЕПСОстатки.Субконто2 В (&МассивКомиссий)
		|				ТОГДА ЕПСОстатки.ВалютнаяСуммаОстаток
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК ОстатокКомиссий,
		|	СУММА(ВЫБОР
		|			КОГДА ЕПСОстатки.Субконто2 = &ЧастьЦеннаяБумага
		|				ТОГДА ЕПСОстатки.ВалютнаяСуммаОстаток
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК ОстатокЦБ,
		|	СУММА(ВЫБОР
		|			КОГДА ЕПСОстатки.Субконто2 = &ЧастьЦеннаяБумага
		|				ТОГДА ЕПСОстатки.КоличествоОстаток
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК КоличествоЦБ
		|ИЗ
		|	РегистрБухгалтерии.ЕПС.Остатки(
		|			&МоментВремени,
		|			Счет В (&СчетаОблигаций),
		|			&ВидыСубконтоЕПС,
		|			Субконто1 В (&Облигации)
		|				И Субконто2 В (&ВсеЧастиЦБ)
		|				И Субконто3 В (&Партии)) КАК ЕПСОстатки
		|
		|СГРУППИРОВАТЬ ПО
		|	ЕПСОстатки.Субконто1,
		|	ЕПСОстатки.Субконто3";
	
	Запрос.УстановитьПараметр("МассивПремияДисконт", МассивПремияДисконт);
	Запрос.УстановитьПараметр("МассивКомиссий", МассивКомиссий);
	Запрос.УстановитьПараметр("ЧастьЦеннаяБумага", ЧастьЦеннаяБумага);
	Запрос.УстановитьПараметр("ВсеЧастиЦБ", ВсеЧастиЦБ);
	Запрос.УстановитьПараметр("ВидыСубконтоЕПС", ВидыСубконтоЕПС);
	
	Запрос.УстановитьПараметр("МоментВремени", РегламентноеЗакрытиеПериода.МоментВремениЗапросов(ЭтотОбъект));
	Запрос.УстановитьПараметр("Облигации", Амортизация.ВыгрузитьКолонку("Актив"));
	Запрос.УстановитьПараметр("Партии", Амортизация.ВыгрузитьКолонку("Партия"));
	Запрос.УстановитьПараметр("СчетаОблигаций", УчетЕПСПовтИсп.СчетаУчетаОблигаций());
	
	Результат = Запрос.Выполнить().Выгрузить();
	Результат.Индексы.Добавить("Актив, Партия");
	
	Возврат Результат;
	
КонецФункции
