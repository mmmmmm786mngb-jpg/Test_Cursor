# Работа с 1С через Python (COM) - Краткое правило

## Инициализация и подключение

```python
pythoncom.CoInitialize()
com = win32com.client.Dispatch("V83.COMConnector")
conn = com.Connect("Srvr='localhost';Ref='база';")
# В конце: pythoncom.CoUninitialize()
```

## КРИТИЧЕСКИ ВАЖНО - Правильные типы объектов

✅ ПРАВИЛЬНО:

- СправочникМенеджер - для создания/чтения элементов справочника
- ДокументМенеджер - для работы с документами  
- Запрос - для выполнения SQL-запросов

❌ НЕПРАВИЛЬНО (НЕ работает):

- СправочникОбъект - Property can not be set
- conn.Справочники() - Член группы не найден

## Создание элемента справочника (ОБЯЗАТЕЛЬНЫЙ порядок)

```python
# 1. Получить менеджер
manager = conn.NewObject("СправочникМенеджер.ИмяСправочника")

# 2. Создать элемент
element = manager.СоздатьЭлемент()

# 3. Заполнить свойства
element.Наименование = "Значение"

# 4. Записать
element.Записать()
```

## Получение метаданных

```python
metadata = conn.Метаданные
catalogs = metadata.Справочники  # или Документы, Константы
```

## Выполнение запросов

```python
# Простой запрос
query = "ВЫБРАТЬ 1 КАК Один"
q = conn.NewObject("Запрос", query)
r = q.Execute().Unload()
result = r[0].Один  # получаем значение

# Запрос с данными
query = """
ВЫБРАТЬ ПЕРВЫЕ 10
    Номенклатура.Код,
    Номенклатура.Наименование
ИЗ
    Справочник.Номенклатура КАК Номенклатура
"""

q = conn.NewObject("Запрос", query)
r = q.Execute().Unload()

for row in r:
    print(row.Код, row.Наименование)
```

## Удаление элементов справочника

```python
# 1. Получить менеджер
manager = getattr(conn.Справочники, "ИмяСправочника")

# 2. Найти элемент по наименованию
find = getattr(manager, "НайтиПоНаименованию", None)
ref = find("ИмяЭлемента")

# 3. Проверить что элемент найден и удалить
if not ref.Пустая():
    ref.ПолучитьОбъект().Удалить()
```

## Типичные ошибки

1. "Property can not be set" → используйте СправочникМенеджер
2. "Тип не определен" → проверьте регистр и правильность имени
3. COM не подключается → откройте 1С вручную (для файловой базы)

## Вызов процедур общих модулей

```python
# Получить модуль
common_module = getattr(conn, "ИмяМодуля", None)

# Вызвать процедуру
common_module.ИмяПроцедуры("параметр1", "параметр2")
```

## Работа с обработками

```python
# ВАЖНО: Строка подключения должна содержать App и Locale
conn = com.Connect("Srvr='localhost';Ref='база';App='PyCOM';Locale=ru_RU;")

# 1. Получить менеджер обработки
manager = getattr(conn.Обработки, "ИмяОбработки")

# 2. Создать объект обработки
obj = manager.Создать()

# 3. Вызвать экспортную функцию модуля объекта
result = obj.ИмяЭкспортнойФункции(параметр1, параметр2)
```

## Вызов экспортных функций модулей объектов обработок

```python
# Пример: вызов функции ПолучитьДанныеНСИДляЗаполнения
# из обработки ОбработкаError

# 1. Подключение с App и Locale (ОБЯЗАТЕЛЬНО!)
conn = com.Connect("Srvr='localhost';Ref='база';App='PyCOM';Locale=ru_RU;")

# 2. Получить менеджер обработки
manager = getattr(conn.Обработки, "ОбработкаError")

# 3. Создать объект
obj = manager.Создать()

# 4. Вызвать функцию модуля объекта
result = obj.ПолучитьДанныеНСИДляЗаполнения(True, False)
# Параметры: ЗаполнятьВсе=True, ОтладочныйРежим=False
```

## Ключевые различия API

- Для СОЗДАНИЯ: manager = conn.NewObject("СправочникМенеджер.Имя")
- Для УДАЛЕНИЯ: manager = getattr(conn.Справочники, "Имя")
- Для ВЫЗОВА ПРОЦЕДУР: getattr(conn, "ИмяМодуля") + модуль.Процедура()
- Для ОБРАБОТОК: getattr(conn.Обработки, "Имя") + manager.Создать() + obj.Функция()

## Помнить ВСЕГДА

- Используйте СправочникМенеджер, НЕ СправочникОбъект
- Сначала СоздатьЭлемент(), потом заполнять поля
- Обязательно Записать() после изменений
- Для УДАЛЕНИЯ: getattr(conn.Справочники, "Имя") + ref.ПолучитьОбъект().Удалить()
- Для ЗАПРОСОВ: conn.NewObject("Запрос", query) + Execute().Unload()
- Для ВЫЗОВА ПРОЦЕДУР: getattr(conn, "ИмяМодуля") + модуль.Процедура()
- Для ОБРАБОТОК: getattr(conn.Обработки, "Имя") + manager.Создать() + obj.Функция()
- Для обработок: ОБЯЗАТЕЛЬНО указать App='PyCOM' и Locale=ru_RU в строке подключения
